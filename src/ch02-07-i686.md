# Working with i686

If you are working with multiple architecture targets, e.g. x86_64 and i686, it is strongly recommended that you have a separate clone of the repository for each architecture. This will help avoid fiddling with config values and build objects, which can result in hard to debug problems. Remember to set your [Config Values](#config-values) before starting your first build.

## FIRST TIME BUILD

### Bootstrap Pre-Requisites And Fetch Sources

Run the following commands, as with the x86_64 preparation:

```sh
sudo apt-get install curl # Pop!_OS/Ubuntu/Debian
```

then
```sh
mkdir -p ~/redox-i686
cd ~/redox-i686
curl -sf https://gitlab.redox-os.org/redox-os/redox/raw/master/bootstrap.sh -o bootstrap.sh
time bash -e bootstrap.sh
```

You will be asked to confirm various installations. Answer in the affirmative (*y* or *1* as appropriate).
The above does the following:
 - creates a parent folder called "redox-i686". Within that folder, it will create another folder called "redox" where all the sources will reside.
 - installs the pre-requisite packages using your operating system's package manager (Pop!_OS/Ubuntu/Debian `apt`, Redhat/Centos/Fedora `dnf`, Arch Linux `pacman`).
 - clones the Redox code from GitLab and checks out a redox-team tagged version of the different subprojects intended for the community to test and submit success/bug reports for.

Please be patient, this can take 5 minutes to an hour depending on the hardware and network you're running it on. Once it completes, update your path in the current shell with
```sh
source ~/.cargo/env
```

### Install Emulator Package

The **i386** emulator is not installed by bootstrap.sh. You can add it like this (Pop!_OS/Ubuntu/Debian):
```sh
sudo apt-get install qemu-system-i386
```

### Config Values

Before your first build, be sure to set the **ARCH** variable to your architecture type, in this case **i686**.

You can also adjust the **FILESYSTEM_SIZE** for the emulation or the *livedisk* in-memory filesystem. The filesystem size is specified in Megabytes (MB).  The default is 256MB. You might want a bigger size, like 1GB (1024MB). For the *livedisk* system, don't exceed the size of your RAM, and leave room for the system to run.

The set of packages to be installed in the filesystem is determined by **FILESYSTEM_CONFIG**. which points to a `.toml` file in the folder `config/$ARCH`, e.g. `config/$(ARCH)/desktop.toml`. There are a few samples provided. Set it to point to your preferred filesystem contents, or copy one and edit it to create your own.

Open with your favourite text editor (gedit, vim or emacs) **redox/mk/config.mk**, and search for each of these values.
```sh
cd ~/redox-i686/redox
gedit mk/config.mk &
```

```toml
...
ARCH?=i686
...
FILESYSTEM_CONFIG?=config/$(ARCH)/desktop.toml
...
FILESYSTEM_SIZE?=1024
```

There are several other settings you can modify, have a look at **redox/mk/config.mk** to see what applies to you. 

### Add packages to the filesystem.

You can add programs to the filesystem by following the instructions [here](./ch05-03-compiling-program.html).

### ADVANCED USERS

For more details on the build process, please read [Advanced Build](./ch02-06-advanced-build.html).

## Compiling The Entire Redox Project

Now we have:
 - fetched the sources
 - set the **ARCH** to **i686**
 - tweaked the settings to our liking
 - possibly added our very own source/binary package to the filesystem

We are ready to build the entire Redox Operating System Image.

### Building an image for emulation
```sh
cd ~/redox-i686/redox
time make all
```
will make the target `build/hardrive.img`, which you can run with an emulator. See [Running Redox](#running-redox).

### Building Redox Live CD/USB Image for **i686**
```sh
cd ~/redox-i686/redox
time make live
```
will make the target `build/livedisk.iso`, which can be copied to a USB drive or CD for booting or installation. See [Running Redox on real hardware](./ch02-03-real-hardware.html).


Give it a while. Redox is big.
- The two main targets `build/harddrive.img` and `build/livedisk.iso` fetch some sources for the core tools from the redox-os source servers, then builds them.  As it progressively cooks each package, it fetches the respective package's sources and builds it.
- creates a few empty files holding different parts of the final image filesystem.
- using the newly built core tools, it builds the non-core packages into one of those filesystem parts
- fills the remaining filesystem parts appropriately with stuff built by the core tools to help boot Redox.
- merges the the different filesystem parts into a final Redox Operating System respective image ready-to-run in Qemu.

### Cleaning Previous Build Cycles

#### Cleaning Intended For Rebuilding Core Packages And Entire System

When you need to rebuild core-packages like relibc, gcc and related tools, clean the entire previous build cycle with:
```
cd ~/redox-i686/redox/
rm -rf prefix/x86_64-unknown-redox/relibc-install/ cookbook/recipes/gcc/{build,sysroot,stage*} build/harddrive.img
```

#### Cleaning Intended For Only Rebuilding Non-Core Package(s)

If you're only rebuilding a non-core package,
you can partially clean the previous build cycle just enough to force rebuilding the Non-Core Package:
```
cd ~/redox-i686/redox/
rm build/harddrive.img
```

## Running Redox

### Running The Redox Desktop

To run Redox, do:
```sh
make qemu
```
This should open up a Qemu window, booting to Redox.

If it does not work, try:

```sh
make qemu kvm=no # we disable KVM
```

or:

```sh
make qemu iommu=no
```

If this doesn't work either, you should go open an issue.

### Running The Redox Console Only

We disable to GUI desktop by passing "vga=no".  The following disables the graphics support and welcomes you with the Redox console:
```sh
make qemu vga=no 
```

It is advantageous to run the console in order to capture the output from the non-gui applications.
It helps to debug applications and share the console captured logs with other developers in the redox community.

### Running The Redox Console With A Qemu Tap For Network Testing

Expose Redox to other computers within a LAN. Configure Qemu with a "TAP" which will allow other computers to test Redox client/server/networking capabilities.

Here are the steps to configure Qemu Tap:
**WIP**

### Note

If you encounter any bugs, errors, obstructions, or other annoying things, please report the issue to the [Redox repository]. Thanks!

[Redox repository]: https://gitlab.redox-os.org/redox-os/redox
